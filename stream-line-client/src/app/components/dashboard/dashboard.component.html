<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar border-end">
      <h5 class="p-3">Channels</h5>
      <ul class="list-group list-group-flush" style="max-height: 40vh; overflow-y: auto;">
        <li
          class="list-group-item d-flex justify-content-between align-items-center channel-item"
          *ngFor="let channel of channels"
          (click)="onSelectChannel(channel)">
          <span >{{ channel.name }}</span>
          <div class="dropdown">
            <button
              class="btn btn-sm btn-light"
              type="button"
              id="channelMenuButton{{ channel.id }}"
              data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul
              class="dropdown-menu dropdown-menu-end"
              [attr.aria-labelledby]="'channelMenuButton' + channel.id">
              <li><a class="dropdown-item" (click)="onViewMembers(channel.id)">View members</a></li>
              <li *ngIf="currentLoggedUsername!=channel.ownerUsername"><a class="dropdown-item" (click)="onLeaveChannel(channel.id)">Leave channel</a></li>
              <li *ngIf="isAdminOfChannel(channel) || isOwnerOfChannel(channel)"><a class="dropdown-item" (click)="onAddUserToChannel(channel.id)">Add member</a></li>
              <li *ngIf="isAdminOfChannel(channel) || isOwnerOfChannel(channel)"><a class="dropdown-item" (click)="onRenameChannel(channel.id)">Rename</a></li>
              <li *ngIf="isOwnerOfChannel(channel)"><a class="dropdown-item text-danger" (click)="onDeleteChannel(channel.id)">Delete</a></li>
            </ul>

          </div>
        </li>
      </ul>

      <h5 class="p-3">Friends</h5>
      <ul class="list-group list-group-flush" style="max-height: 40vh; overflow-y: auto;">
        <li
          class="list-group-item d-flex justify-content-between align-items-center channel-item"
          *ngFor="let friend of friends"
          (click)="onSelectFriend(friend)">
          <span >{{ friend.username }}</span>
          <div class="dropdown">
            <button
              class="btn btn-sm btn-light"
              type="button"
              id="friendMenuButton{{ friend.id }}"
              data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul
              class="dropdown-menu dropdown-menu-end"
              [attr.aria-labelledby]="'friendMenuButton' + friend.id">
              <li><a class="dropdown-item" (click)="onAddFriendToChannel(friend.username)">Add to channel</a></li>
              <li><a class="dropdown-item text-danger" (click)="onRemoveFriend(friend.username)">Remove</a></li>
            </ul>

          </div>
        </li>
      </ul>

      <!-- Create Channel Button -->
      <div class="p-3">
        <button class="btn btn-success w-100 mb-2" (click)="onCreateChannel()">
          Create Channel
        </button>
        <button class="btn btn-primary w-100" (click)="onAddFriend()">
          Add Friend
        </button>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-9 chat">
      <div class="p-3">
        <h4 class="border-bottom pb-2">{{ selectedChatName }}</h4>
        <div class="chat-messages" style="height: 80vh; overflow-y: auto; background-color: #f1f1f1; padding: 10px;">
          <div *ngFor="let message of messages" class="mb-3">
            <strong>{{ message.authorUsername == currentLoggedUsername ? 'You' : message.authorUsername }}:</strong> {{ message.content }}
            <span class="text-muted" style="font-size: 0.9em;">{{ message.timestamp | date:'yyyy-MM-dd HH:mm:ss' }}</span>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="mt-3">
          <form class="d-flex" (ngSubmit)="onSendMessage()">
            <input
              type="text"
              class="form-control me-2"
              placeholder="Type a message..."
              [(ngModel)]="newMessage"
              name="messageInput">
            <button type="submit" class="btn btn-primary">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden modal template -->
<div #userListTemplate style="display: none;">
  <div *ngFor="let user of channelsMembersList" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding: 5px;">
    <span>{{ user.username }}</span>
    <div>
      <button
        (click)="toggleAdmin(user.id)"
        style="margin-right: 10px; background-color: green; color: white; border: none; padding: 5px 10px; cursor: pointer;">
        {{ user.role ? 'Revoke Admin' : 'Make Admin' }}
      </button>
      <button
        (click)="removeUser(user.username)"
        style="background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer;">
        Remove User
      </button>
    </div>
  </div>
</div>
